<mat-form-field
  [formGroup]="group"
  *ngIf="!fieldIsReadonly && !fieldIsHidden"
  [floatLabel]="loading$.value || fieldControl.disabled ? 'never' : 'auto'"
  class="lab900-select-field"
  [class.has-value]="fieldControl?.value?.length"
  id="lab900-select-field-{{ fieldAttribute }}"
>
  <mat-label *ngIf="schema?.title">
    <ng-container *ngIf="loading$.value">{{
      'form.field.loading' | translate
    }}</ng-container>
    <ng-container *ngIf="schema.title && !loading$.value">{{
      schema.title | translate
    }}</ng-container>
  </mat-label>
  <mat-select
    #select
    placeholder="{{ placeholder | translate }}"
    [compareWith]="options?.compareWith ? options?.compareWith : defaultCompare"
    [formControlName]="fieldAttribute"
    [multiple]="options?.multiple"
    [required]="fieldIsRequired"
    msInfiniteScroll
    [complete]="!options?.infiniteScroll?.enabled"
    [threshold]="options?.infiniteScroll?.threshold || '15%'"
    [debounceTime]="options?.infiniteScroll?.debounceTime || 150"
    (infiniteScroll)="onScroll()"
  >
    <mat-select-trigger *ngIf="options?.customTriggerFn">
      <div [innerHTML]="options?.customTriggerFn(fieldControl.value)"></div>
    </mat-select-trigger>
    <mat-option
      *ngIf="options?.search?.enabled"
      (keydown.enter)="onSearchEnter($event)"
      [disabled]="true"
    >
      <ngx-mat-select-search
        [ngModel]="(optionsFilter$ | async)?.searchQuery || ''"
        [searching]="loading$.value"
        (ngModelChange)="onSearch($event)"
        [ngModelOptions]="{ standalone: true }"
        [placeholderLabel]="
          options?.search?.placeholder || 'form.field.search' | translate
        "
        [noEntriesFoundLabel]="
          options?.search?.notFoundLabel || 'form.field.no_options_found'
            | translate
        "
        [disableScrollToActiveOnOptionsChanged]="
          options?.infiniteScroll?.enabled
        "
        [clearSearchInput]="options?.search?.clearOnClose || false"
      ></ngx-mat-select-search>
    </mat-option>
    <div
      *ngIf="options?.multiple && options?.selectAll?.enabled"
      class="select-all"
      style="margin: 5px 17px"
    >
      <mat-checkbox
        [(ngModel)]="allSelected"
        [ngModelOptions]="{ standalone: true }"
        [disabled]="this.options.selectAll?.disabled"
        (change)="handleToggleAllSelection()"
      >
        {{
          options.selectAll?.label || 'forms.select-field.selectAllLabel'
            | translate
        }}
      </mat-checkbox>
    </div>
    <mat-option
      *ngFor="let item of selectOptions"
      [value]="item.value"
      [disabled]="item.disabled || loading$.value"
      (click)="
        options?.multiple ? handleSelectAllEnabledOptionClick() : undefined
      "
    >
      <div
        *ngIf="options?.displayOptionFn"
        [innerHTML]="options.displayOptionFn(item) | translate"
      ></div>
      <div
        *ngIf="!options?.displayOptionFn"
        [innerHTML]="item.label | translate"
      ></div>
    </mat-option>
  </mat-select>
  <button
    *ngIf="showClearButton(this.fieldControl.value)"
    matSuffix
    mat-icon-button
    type="button"
    aria-label="Clear"
    (click)="handleClearFieldButtonClick($event)"
  >
    <mat-icon>close</mat-icon>
  </button>

  <mat-hint
    *ngIf="hint && !(schema.options.hint.hideHintOnValidValue && select.value)"
    ><span [innerHTML]="hint | translate: hintValueTranslateData"></span
  ></mat-hint>
  <mat-error *ngIf="!valid"
    ><span [innerHTML]="getErrorMessage(this.group) | async"></span
  ></mat-error>
</mat-form-field>

<div class="lab900-readonly-field" *ngIf="fieldIsReadonly && !fieldIsHidden">
  <span
    *ngIf="options?.readonlyLabel || schema.title"
    class="lab900-readonly-field__label"
    >{{ options?.readonlyLabel || schema.title | translate }}</span
  >
  <div
    *ngIf="!loading$.value || !fieldControl.value"
    [innerHTML]="getReadOnlyDisplay()"
  ></div>
  <div *ngIf="loading$.value && fieldControl.value">
    {{ 'form.field.loading' | translate }}
  </div>
</div>
